<!DOCTYPE html>
<html>
<head>
   <title>GlobalChat WebSocket Test</title>
   <style>
       .message-container {
           margin: 20px;
           padding: 10px;
           border: 1px solid #ccc;
           height: 400px;
           overflow-y: auto;
       }
       .message {
           margin: 5px;
           padding: 10px;
           border-radius: 5px;
       }
       .received {
           background-color: #e9ecef;
           margin-right: 20%;
       }
       .sent {
           background-color: #d4edda;
           margin-left: 20%;
           text-align: right;
       }
       .translation {
           font-style: italic;
           color: #666;
           margin-top: 5px;
           padding-top: 5px;
           border-top: 1px solid #ddd;
       }
       .user-info {
           margin: 10px 0;
           padding: 10px;
           background-color: #f8f9fa;
           border-radius: 5px;
       }
       .controls {
           margin: 10px;
           padding: 10px;
       }
       input[type="text"], input[type="email"], input[type="password"] {
           padding: 5px;
           margin: 5px;
           width: 300px;
       }
       button {
           padding: 5px 10px;
           margin: 5px;
       }
       #connectionStatus {
           margin-left: 10px;
           font-weight: bold;
       }
       .login-section {
           margin: 20px;
           padding: 20px;
           border: 1px solid #ddd;
           border-radius: 5px;
       }
       .chat-section {
           display: none;
           margin: 20px;
       }
   </style>
</head>
<body>
   <h1>GlobalChat Test Client</h1>
   
   <div id="loginSection" class="login-section">
       <h2>Login</h2>
       <div>
           <input type="text" id="email" placeholder="Username">
       </div>
       <div>
           <input type="password" id="password" placeholder="Password">
       </div>
       <button onclick="login()">Login</button>
   </div>

   <div id="chatSection" class="chat-section">
       <div class="user-info" id="userInfo">
           Not logged in
       </div>

       <div class="controls">
           <button onclick="connect()">Connect WebSocket</button>
           <span id="connectionStatus">Not Connected</span>
       </div>

       <div class="message-container" id="messages"></div>

       <div class="controls">
           <input type="text" id="messageInput" placeholder="Type a message">
           <select id="languageSelect">
               <option value="en">English</option>
               <option value="es">Spanish</option>
               <option value="fr">French</option>
           </select>
           <button onclick="sendMessage()">Send</button>
       </div>
   </div>

   <script>
       let ws = null;
       let currentUser = null;
       let currentToken = null;

       async function login() {
           const email = document.getElementById('email').value;
           const password = document.getElementById('password').value;

           try {
               const formData = new URLSearchParams();
               formData.append('username', email);
               formData.append('password', password);

               const response = await fetch('http://localhost:8000/api/auth/login', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/x-www-form-urlencoded',
                   },
                   body: formData.toString()
               });

               if (response.ok) {
                   const data = await response.json();
                   currentToken = data.access_token;
                   await getUserInfo();
                   document.getElementById('loginSection').style.display = 'none';
                   document.getElementById('chatSection').style.display = 'block';
               } else {
                   const errorData = await response.json();
                   console.error('Login error:', errorData);
                   alert(`Login failed: ${errorData.detail || 'Unknown error'}`);
               }
           } catch (e) {
               console.error('Login error:', e);
               alert('Login failed');
           }
       }

       async function getUserInfo() {
           try {
               const response = await fetch('http://localhost:8000/api/auth/me', {
                   headers: {
                       'Authorization': `Bearer ${currentToken}`
                   }
               });
               if (response.ok) {
                   currentUser = await response.json();
                   updateUserInfo();
               }
           } catch (e) {
               console.error('Error fetching user info:', e);
           }
       }

       function updateUserInfo() {
           document.getElementById('userInfo').innerHTML = `
               Logged in as: ${currentUser.username}<br>
               Preferred Language: ${currentUser.preferred_language}<br>
               Auto-translate: ${currentUser.auto_translate ? 'Enabled' : 'Disabled'}
           `;
           document.getElementById('languageSelect').value = currentUser.preferred_language;
       }

       async function connect() {
           if (!currentToken) {
               alert('Please login first');
               return;
           }

           // Connect WebSocket
           ws = new WebSocket(`ws://localhost:8000/ws/${currentToken}`);
           
           ws.onopen = function() {
               document.getElementById('connectionStatus').textContent = 'Connected';
               document.getElementById('connectionStatus').style.color = 'green';
           };

           ws.onmessage = function(event) {
               const message = JSON.parse(event.data);
               const messagesDiv = document.getElementById('messages');
               
               // Create message element
               const messageElement = document.createElement('div');
               messageElement.className = 'message received';
               
               // Add message content
               messageElement.innerHTML = `
                   <strong>${message.sender.username}:</strong>
                   <span>${message.content}</span>
                   <div><small>Original language: ${message.original_language}</small></div>
               `;

               // Add translation if available and needed
               if (message.original_language !== currentUser.preferred_language && 
                   message.translations && 
                   message.translations[currentUser.preferred_language]) {
                   const translationDiv = document.createElement('div');
                   translationDiv.className = 'translation';
                   translationDiv.textContent = message.translations[currentUser.preferred_language];
                   messageElement.appendChild(translationDiv);
               }

               messagesDiv.appendChild(messageElement);
               messagesDiv.scrollTop = messagesDiv.scrollHeight;
           };

           ws.onclose = function() {
               document.getElementById('connectionStatus').textContent = 'Disconnected';
               document.getElementById('connectionStatus').style.color = 'red';
           };
       }

       function sendMessage() {
           const content = document.getElementById('messageInput').value;
           const language = document.getElementById('languageSelect').value;
           
           if (ws && content) {
               // Add message to display
               const messagesDiv = document.getElementById('messages');
               const messageElement = document.createElement('div');
               messageElement.className = 'message sent';
               messageElement.innerHTML = `
                   <strong>You:</strong>
                   <span>${content}</span>
                   <div><small>Original language: ${language}</small></div>
               `;
               messagesDiv.appendChild(messageElement);
               messagesDiv.scrollTop = messagesDiv.scrollHeight;

               // Send via WebSocket
               ws.send(JSON.stringify({
                   content: content,
                   original_language: language
               }));
               document.getElementById('messageInput').value = '';
           }
       }

       // Allow pressing Enter to send message
       document.getElementById('messageInput').addEventListener('keypress', function(e) {
           if (e.key === 'Enter') {
               sendMessage();
           }
       });

       // Allow pressing Enter to login
       document.getElementById('password').addEventListener('keypress', function(e) {
           if (e.key === 'Enter') {
               login();
           }
       });
   </script>
</body>
</html>